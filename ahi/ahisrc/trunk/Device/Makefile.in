#  $Id$
#
#  Makefile.in for the AHI preferences program
#

# The CPU to generate code for:

CPU	= 68030

#Can be VERSION68K, VERSIONGEN, VERSIONPOWERUP or VERSIONWARPUP:

VER	= VERSION68K
			

#
# Autoconfig stuff
########################################

@SET_MAKE@

top_srcdir	= @top_srcdir@
srcdir		= @srcdir@
DISTDIR		= @DISTDIR@
DEVSDIR		= ${DISTDIR}/User/Devs
CATDIR		= ${DISTDIR}/User/Catalogs

build_os	= @build_os@

CC		= @CC@
INSTALL		= @INSTALL@
INSTALL_PROGRAM	= @INSTALL_PROGRAM@
FLEXCAT		= @FLEXCAT@
ASM		= @ASM@

CPPFLAGS	= @CPPFLAGS@ -I${top_srcdir}
CFLAGS		= @CFLAGS@ -m$(CPU)
LDFLAGS		= @LDFLAGS@ -nostartfiles
LIBS		= @LIBS@
ASMFLAGS	= I INCLUDE: SYMDEBUG LINEDEBUG QUIET NOEXE OPT NRQBPSMD \
		  MACHINE $(CPU) SET "$(VER)"

VPATH		= @srcdir@


ifeq ($(strip $(FLEXCAT)),)
FLEXCAT		= @echo 'FlexCat not found; cannot make $@!'; false \#
endif

ifeq ($(strip $(ASM)),)
ASM		= @echo 'No suitable assembler found; cannot make $@!'; false \#
endif


#
# Files
########################################

SOURCES		= $(wildcard *.c)

OBJECTS		= header.o device.o devcommands.o devsupp.o \
		  localize.o modeinfo.o requester.o database.o debug.o\
		  asmfuncs.o audioctrl.o effectinit.o sound.o footer.o

ifeq ($(VER),VERSION68K)
OBJECTS		+= dspecho_68k.o mixer_68k.o
else
OBJECTS		+= dspecho.o mixer.o
endif

TARGET		= ahi.device.$(CPU)

LANGUAGES	= $(notdir $(basename $(wildcard translations/*.ct)))
CATALOGS	= $(addsuffix .catalog, $(LANGUAGES))


#
# Targets
########################################

.PHONY:		all clean distclean maintainer-clean bindist revup


all:		$(TARGET) ahi.ct $(CATALOGS)

mostlyclean:
	$(RM) $(TARGETS) *.o *.bak *~ \#*\# core Makefile.dep

clean:		mostlyclean
	$(RM) $(LANGTARGETS) version.h version.i *.catalog

distclean:	clean
	$(RM) Makefile

maintainer-clean: distclean

device:		$(TARGET)

bindist:
	$(INSTALL) --directory $(DEVSDIR)

	make device VER=VERSION68K CPU=68000
	$(INSTALL_PROGRAM)  $(DEVSDIR)


version.i:	version.rev version.date
	@echo Creating $@
	@ver=`cat $(top_srcdir)/version.ver` \
	 rev=`cat version.rev` && \
	 echo "VERSION  EQU $$ver" >$@ && \
	 echo "REVISION EQU $$rev" >>$@

version.h:	version.rev version.date
	@echo Creating $@
	@ver=`cat $(top_srcdir)/version.ver` \
	 rev=`cat version.rev` \
	 date=`cat version.date` && \
	 echo "#define VERS \"$$ver.$$rev ($$date)\"" > $@

revup:
	@rev=`cat version.rev` && echo `expr $$rev + 1` > version.rev
	@date +%y.%m.%d > version.date
	@echo -n "New revision: "
	@cat version.rev

#
# Auto-remake autoconf stuff
########################################

Makefile: Makefile.in ../config.status
	(cd .. && ./config.status)


#
# Rules
########################################

%.o:	%.s
	$(ASM) $(ASMFLAGS) $<


$(TARGET):	$(OBJECTS)
	$(CC) $(LDFLAGS) $^ $(LIBS) -o $@

localize.c:	ahi.cd C_c_AHI.sd
	$(FLEXCAT) ahi.cd localize.c=C_c_AHI.sd 

localize.h:	ahi.cd C_c_AHI.sd
	$(FLEXCAT) ahi.cd localize.h=C_h_AHI.sd

%.catalog:	translations/%.ct
	$(FLEXCAT) ahi.cd $< CATALOG $@

%.ct:
	$(FLEXCAT) ahi.cd $@ NEWCTFILE $@


#
# Dependencies
########################################

Makefile.dep:	$(SOURCES) localize.c localize.h version.h
ifneq ($(build_os),amigaos)
	-@$(CC) $(CPPFLAGS) $(CFLAGS) -MM $(SOURCES) > $@
else
	# This is much faster...
	-@touch $@
	-@makedepend -f $@ $(SOURCES)
endif

include Makefile.dep

asmfuncs.o:	asmfuncs.s ahi_def.i
devsupp.o:	devsupp.s
dspecho_68k.o:	dspecho_68k.s ahi_def.i dsp.i
footer.o:	footer.s
header.o:	header.s ahi_def.i version.i
mixer_68k.o:	mixer_68k.s ahi_def.i dsp.i

$(wildcard translations/*.ct) ahi.ct:	ahi.cd

