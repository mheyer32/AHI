#  $Id$
#
#  Makefile.in for the AHI sound system
#

#
# Autoconfig stuff
########################################

@SET_MAKE@

top_srcdir	= @top_srcdir@
srcdir		= @srcdir@
DISTDIR		= @DISTDIR@
CATDIR		= ${DISTDIR}/User/Catalogs

INSTALL		= @INSTALL@
INSTALL_DATA	= @INSTALL_DATA@
LHA		= @LHA@

CPPFLAGS	= @CPPFLAGS@
CFLAGS		= @CFLAGS@
LDFLAGS		= @LDFLAGS@


VPATH		= @srcdir@


#
# Targets
########################################

.PHONY:		all clean distclean maintainer-clean bindist revup

SUBDIRS		= AHI AHI-Handler AddAudioModes Device Docs Drivers Examples Include


all:
	@cd Include && make gcc-include
	@for i in $(SUBDIRS); do (cd $$i && $(MAKE) $(MFLAGS) $@) || exit; done

clean:
	-@for i in $(SUBDIRS); do (cd $$i && $(MAKE) $(MFLAGS) $@); done
	$(RM) ahi6dev.lha ahi6dev.readme ahi6usr.lha ahi6usr.readme

distclean:
	-@for i in $(SUBDIRS); do (cd $$i && $(MAKE) $(MFLAGS) $@); done
	$(RM) ahi6dev.lha ahi6dev.readme ahi6usr.lha ahi6usr.readme \
	      config.log config.cache config.status config.h\
	      stamp-h stamp-h.in Makefile

maintainer-clean:
	-@for i in $(SUBDIRS); do (cd $$i && $(MAKE) $(MFLAGS) $@); done
	$(RM) ahi6dev.lha ahi6dev.readme ahi6usr.lha ahi6usr.readme \
	      config.log config.cache config.status config.h\
	      stamp-h stamp-h.in Makefile \
	      configure config.h.in

bindist:
	$(RM) -r $(DISTDIR)
	$(INSTALL) --directory $(DISTDIR)
	$(INSTALL_DATA) ${srcdir}/COPYING $(DISTDIR)
	$(INSTALL_DATA) ${srcdir}/COPYING.LIB $(DISTDIR)
	$(INSTALL_DATA) ${srcdir}/COPYING.DRIVERS $(DISTDIR)
	$(INSTALL_DATA) ${srcdir}/ChangeLog $(DISTDIR)

	$(INSTALL) --directory $(CATDIR)
	$(INSTALL_DATA) ${srcdir}/README.ATO $(CATDIR)
	$(INSTALL_DATA) ${srcdir}/README.TRANSLATIONS $(CATDIR)

	cd Include && make gcc-include
	for i in $(SUBDIRS); do (cd $$i && $(MAKE) $(MFLAGS) $@) || exit; done

	-$(RM) ahi6dev.lha ahi6usr.lha
	pwd=`pwd` && ( cd $(DISTDIR) && $(LHA) -a $${pwd}/ahi6dev.lha \
	  ahidev* ChangeLog COPYING* Developer )
	cp $(DISTDIR)/ahidev.readme ahi6dev.readme

	pwd=`pwd` && ( cd $(DISTDIR) && $(LHA) -a $${pwd}/ahi6usr.lha \
	  ahiusr* ChangeLog COPYING* User )
	cp $(DISTDIR)/ahiusr.readme ahi6usr.readme

	$(RM) -r $(DISTDIR)

revup:
	@rev=`cat $(srcdir)/version.rev` && echo `expr $$rev + 1` > $(srcdir)/version.rev
	@date +%y.%m.%d > $(srcdir)/version.date
	@echo -n "New revision: "
	@cat $(srcdir)/version.rev

#
# Auto-remake autoconf stuff
########################################

${srcdir}/configure: configure.in
	cd ${srcdir} && autoconf

# autoheader might not change config.h.in, so touch a stamp file.
${srcdir}/config.h.in: stamp-h.in
${srcdir}/stamp-h.in: configure.in
	cd ${srcdir} && autoheader
	echo timestamp > ${srcdir}/stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck
